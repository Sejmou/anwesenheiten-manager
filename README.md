# Anwesenheiten-Manager

TODO: description

## Installing the project locally

This guide only explains how to do this on Ubuntu. Things might be different for Windows or MacOS.

1. Make sure Node and yarn are installed on the machine. This should be as simple as running `sudo apt update && sudo apt install nodejs && sudo apt install yarn`.
2. Run `yarn`. This will install all the Node modules used by this NextJS project.

### Local Test Database Config (Ubuntu)

1. Make sure postgres is installed and running (`psql` command works - [this](https://www.prisma.io/dataguide/postgresql/setting-up-a-local-postgresql-database#debian-and-ubuntu) guide might help)
2. Run `psql` (or `sudo -u postgres psql` if that doesn't work) to login into the "postgres console" (not sure what proper term for it is)
3. In the postgres console, run the following SQL commands (replacing `yourpass` with a password of your choice):
   ```
   CREATE DATABASE anwesenheitslisten_manager;
   CREATE USER anwesenheitslisten_admin WITH PASSWORD 'yourpass';
   GRANT ALL PRIVILEGES ON DATABASE anwesenheitslisten_manager TO anwesenheitslisten_admin;
   ```
   This will create a `anwesenheitslisten_manager` database and a database user `anwesenheitslisten_admin` that essentially has "super-user" access to the database. **NOTE: I am not entirely sure about the security implications of not having an encrypted password. I guess it should be fine as the user is only "reachable" locally anyway?**
4. Now, the database should be accessible via the connection URI `postgresql://anwesenheitslisten_admin:yourpass@localhost/anwesenheitslisten_manager`, replacing `yourpass` with the password you chose earlier. More details on how connection URIs work can be found [here](https://www.prisma.io/dataguide/postgresql/short-guides/connection-uris).
5. Create a `.env` file in the root folder of this project, containing a single line:
   ```
   DATABASE_URL=<connection-uri>
   NEXTAUTH_URL=http://localhost:3000
   NEXTAUTH_SECRET=<some-secret-string>
   ```
   where`<connection-uri>` is the connection URI from the previous step. `NEXTAUTH_URL` and `NEXTAUTH_SECRET` are needed by `nextauth` (for details click [here](https://next-auth.js.org/configuration/options#environment-variables)). Replace `<some-secret-string>` with a random string generated by running `openssl rand -base64 32` on the command line.
6. Run `npx prisma db push`. This will use [Prisma](https://www.prisma.io/), an ORM for Node.js and Typescript, to sync the created database with the database schema defined in `prisma/schema.prisma`. As the database will be empty before we run this command, it essentially just creates all the tables mentioned in the schema.
7. (Optional) Run `npx prisma studio`. This will launch Prisma Studio (Prisma's "database explorer") on your machine and make the GUI available via your browser (per default on `localhost:5555`). You can use it to check out the models used in the database - no records will exist at this point.

Now the database should be ready :)

However, the app is still not yet ready...

### Add other required secrets and API keys

In the `env` file mentioned above, you also need to add other environment variables:

```
INVITE_TOKEN_SECRET=<another-secret-string>
```

The `INVITE_TOKEN_SECRET` is needed for generating invite tokens for new application users (admin accounts). Replace `<another-secret-string>` with another random string generated by running `openssl rand -base64 32`.

```
GOOGLE_API_KEY=<your-api-key>
```

The `GOOGLE_API_KEY` is needed to allow the applcation to use the Google Calendar API for syncing the choir practice events in the database with the choir practice events of the TU Wien Chor [public calendar](https://calendar.google.com/calendar/embed?src=qshfu0pshf6u7emr0f7pn80a3c%40group.calendar.google.com&ctz=Europe%2FVienna). You need to generate it in the Google Developer console. Once you have it, replace `<your-api-key>` with the key you obtained. For details on how to obtain your key, see [here](https://cloud.google.com/docs/authentication/api-keys).

### Launching the application

Now that we've installed the dependencies and the database is set up, the application is ready. Type `yarn dev` to start it.

Then, navigate to `localhost:3000/register` to create a user with a name, email and password of your choice. The credentials will be stored in the database (passwords are encrypted/hashed using `bcrypt`, so they should be quite safe, even if the database were compromised).

After registering, you should be logged in and see the main page. All other users that try to register will need an invitation link. To generate those, you can click on 'Invites'. There, you will see an overview page for all invite links that have been generated (there will be none, initially). To generate a new one, just click the button on that page. You can send the generated link to someone you would like to add as a user.

## How actual deployment on a self-hosted server could work

Here I keep track of what I found out about how to do an actual production deployment.

A requirement for this project is to use a fully self-hosted solution, running everything on a server hosted at the university, which makes things tricky.

### Database setup

Probably we would need to do Database migrations with [`Prisma migrate`](https://www.prisma.io/docs/concepts/components/prisma-migrate) instead of using `db push`. This way, Prisma will create a history of SQL migration files to allow us to keep track of database changes more easily, and also revert if something goes wrong. To make this work, one has to

1. Log into the "postgres console" as the DB super user (like mentioned above)
2. Execute `ALTER USER anwesenheitslisten_admin CREATEDB;` to give the database user for this project the ability to create new databases. This is required for `Prisma migrate` to work properly as it needs to create a "shadow database" in the background, details see [here](https://www.prisma.io/docs/concepts/components/prisma-migrate/shadow-database).
